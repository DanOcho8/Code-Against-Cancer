{% extends 'base.html' %}

{% block content %}
<div class="thread-detail" style="text-align: center; margin-top: 20px">
  <!-- Thread Title -->
  <h1 style="font-size: 36px; font-weight: bold; margin-bottom: 30px">
    {{ object.title }}
  </h1>

  <!-- Posts Section -->
  <div class="posts-section" style="text-align: left; width: 60%; margin: 0 auto">
    <h2 style="font-size: 28px; font-weight: bold; margin-bottom: 20px">
      Posts:
    </h2>

    {% if posts %}
      {% for post in posts %}
        <div
          class="post-item"
          style="
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
          "
        >
          <!-- Post Content -->
          <p style="font-size: 18px; color: #2c3e50">{{ post.content }}</p>
          <p style="font-size: 14px; color: #7f8c8d; margin-top: 10px">
            <small>Posted at: {{ post.created_at|date:"F j, Y, g:i a" }}</small>
            <p>Posted by: {{ post.author.username }}</p>
          </p>

          <!-- Reply Button -->
          <button
            class="reply-button"
            style="
              background-color: #3498db;
              color: white;
              padding: 5px 10px;
              border-radius: 5px;
              border: none;
              cursor: pointer;
            "
            onclick="toggleReplyForm('{{ post.pk }}')"
          >
            Reply
          </button>

          <!-- Reply Form Section -->
          <div id="reply-form-{{ post.pk }}" class="reply-section" style="display: none; margin-top: 20px">
            <h5 style="font-size: 20px; color: #34495e">Reply to this post:</h5>
            <form method="post" action="{% url 'thread_detail' object.pk %}" onsubmit="submitReply(event, '{{ post.pk }}')">
              {% csrf_token %}
              {{ reply_form.as_p }}
              <input type="hidden" name="post_id" value="{{ post.id }}">  <!-- Hidden post ID field -->
              <button
                type="submit"
                style="                 
                    background-color: #2ecc71;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 5px;
                    font-size: 14px;
                    border: none;
                    cursor: pointer;
                "
              >
                Reply
              </button>
            </form>
          </div>

          <!-- Display Replies -->
          {% if post.replies.all %}
            <div class="replies" data-post-id="{{ post.id }}" style="margin-left: 20px; margin-top: 20px">
              {% for reply in post.replies.all %}
                <div
                  class="reply-item"
                  style="
                    background-color: #e8e8e8;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 10px;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                  "
                >
                  <p style="font-size: 16px; color: #2c3e50">{{ reply.content }}</p>
                  <p style="font-size: 12px; color: #7f8c8d">
                    <small>Posted at: {{ reply.created_at|date:"F j, Y, g:i a" }}</small>
                  </p>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p style="color: #7f8c8d; font-size: 16px">No posts in this thread yet.</p>
    {% endif %}
  </div>

  <hr style="width: 60%; margin: 40px auto" />

  <!-- Add New Post Section -->
  <div class="add-post" style="width: 60%; margin: 0 auto; text-align: left">
    <h3 style="font-size: 24px; font-weight: bold; margin-bottom: 20px">
      Add New Post
    </h3>
    <form method="post" action="{% url 'create_post' pk=object.pk %}">
      {% csrf_token %}
      {{ post_form.as_p }}
      <button
        type="submit"
        style="
          background-color: #3498db;
          color: white;
          padding: 10px 20px;
          border-radius: 5px;
          font-size: 16px;
          border: none;
          cursor: pointer;
        "
      >
        Submit
      </button>
    </form>
  </div>
</div>

<script>
  function toggleReplyForm(postId) {
    const form = document.getElementById(`reply-form-${postId}`);
    form.style.display = form.style.display === "none" || form.style.display === "" ? "block" : "none";
  }

  // Function to handle reply form submission with AJAX
  function submitReply(event, form) {
    event.preventDefault(); // Prevent default form submission

    // Ensure form is valid
    if (!form || !(form instanceof HTMLFormElement)) {
      console.error('The provided form is not valid:', form);
      return;
    }

    const postId = form.querySelector('input[name="post_id"]').value; // Get post ID
    const formData = new FormData(form); // Collect form data

    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest' // Indicate that this is an AJAX request
      }
    })
    .then(response => {
      // Log the response for debugging
      console.log('Response:', response);
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json(); // Parse JSON response
    })
    .then(data => {
      if (data.success) {
        // Append the new reply dynamically
        const repliesSection = document.querySelector(`.replies[data-post-id="${postId}"]`);
        const newReply = document.createElement('div');
        newReply.innerHTML = `<p style="font-size: 16px; color: #2c3e50">${data.reply}</p>
                              <p style="font-size: 12px; color: #7f8c8d">
                                <small>Posted by: ${data.author} at: ${data.created_at}</small>
                              </p>`;
        repliesSection.appendChild(newReply);
        form.reset(); // Reset the form
      } else {
        console.error('Failed to add reply:', data.error); // Handle error if not successful
      }
    })
    .catch(error => console.error('Error:', error));
  }

  // Attach the submitReply function to each reply form
  document.querySelectorAll('.reply-section form').forEach(form => {
    form.addEventListener('submit', function(event) {
      submitReply(event, this); // Pass the form (this) as a second argument
    });
  });
</script>


{% endblock %}
